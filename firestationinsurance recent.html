<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Fire Station Insurance COA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="css/bootstrap-responsive.css" rel="stylesheet">

  

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="ico/favicon.png"/>
    <script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
    <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
    <![endif]-->    <!-- <style type="text/javascript">#map { height: 180px; }</style> -->
    <!--<script type="text/javascript" src="/jquery/jquery-1.3.2.min.js"></script> -->
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" language="javascript">


   function UpdateResults(jd,idStr){
         $('#results').append('<p>Entered Address: ' + jd.candidates[0].address + '');
   }
    
   function getLatLong(jd){
	   xStr=jd.candidates[0].location.x;
	   yStr=jd.candidates[0].location.y;
       
       var urlStr = 'http://coa-gis-imagery/COA_Internal_ArcGIS/rest/services/Geometry/GeometryServer/'+
                    'project?inSR=2264&outSR=4326&geometries='+xStr+'%2C'+yStr+'6&f=pjson';
                     
      console.log(urlStr)
       
       $.ajax({
           url: urlStr,
           dataType: 'jsonp',
           crossDomain: true,
           jsonpCallback: 'MyJSONPCallback', // specify the callback name if you're hard-coding it
           jsonp : "callback",
           success:function(data){zoomMap(data);},
           error:function(data){console.log('ajax failed');}
       });
       	   
   }
   
   var zoomMap = function(data){
	   xStr=data.geometries[0].x;
	   yStr=data.geometries[0].y;
	   console.log(data);
	   map.setView(new L.LatLng(yStr, xStr), 15);
	   return '';
	   
   }
   
   function getAddress(closestType,distance){
       $('#loading').css('visibility','visible')
       $('#results').html('');
       addressStr = $('#address').val();
       ZipStr = $('#zone').val();
       var urlStr = 'http://gis.ashevillenc.gov/COA_ArcGIS_Server/rest/services/Buncombe_Address_Point/GeocodeServer/findAddressCandidates?Street='+addressStr+
                    '&Zone='+ZipStr+'&outFields=&f=pjson';
       var pt = [];
       var retVal;
       
       $.ajax({
           url: urlStr,
           dataType: 'jsonp',
           crossDomain: true,
           jsonpCallback: 'MyJSONPCallback', // specify the callback name if you're hard-coding it
           jsonp : "callback",
           success:function(data){getResults(data,closestType,distance);},
           error:function(data){console.log('ajax failed');}
       });
    }
   

    function drawRoute(data){
    
       var path=data.routes.features[0].geometry.paths[0]
       var myLines = '[{"type": "LineString","coordinates":['
       for(var i=0;i< data.routes.features[0].geometry.paths.length;i++)
       {
            //console.log(data.routes.features[0].geometry.paths[i].length);
            for(var j=0;j< data.routes.features[0].geometry.paths[i].length;j++){
                myLines += '['+data.routes.features[0].geometry.paths[i][j]+'],'
            }
       }
       
       myLines=myLines.substring(0, myLines.length-1)
       myLines += ']}]'
       myJsonObject=JSON.parse(myLines);
       
       console.log(myJsonObject)

       var myStyle = {
           "color": "#ff7800",
           "weight": 10,
           "opacity": 0.65
       };

       L.geoJson(myJsonObject, {
           style: myStyle
       }).addTo(map);
    
    }
    
    function makeFacilityEnvelope(jd,distance){
	   xStr=jd.candidates[0].location.x;
	   yStr=jd.candidates[0].location.y;
	   
	   maxX=parseFloat(xStr)+parseFloat(distance);
	   maxY=parseFloat(yStr)+parseFloat(distance);

	   minX=parseFloat(xStr)-parseFloat(distance);
	   minY=parseFloat(yStr)-parseFloat(distance);
	   
	   retVal=maxX+','+maxY+','+minX+','+minY;
	   
	   return retVal;
	   
	   
    }//makeFacilityEnvelope
    
    function getFacilities(jd,closestType,distance){
       

       switch(closestType)
            {
            case 'ClosestFireStation':
                facEnv=makeFacilityEnvelope(jd,10000);
                var urlStr = 'http://coa-gis-imagery/COA_Internal_ArcGIS/rest/services/Publish/test_route/MapServer/1/query?text=&geometry='+facEnv+
                             '&geometryType=esriGeometryEnvelope&inSR=2264&spatialRel=esriSpatialRelEnvelopeIntersects&relationParam=&objectIds=&where=&time='+
                             '&returnIdsOnly=false&returnGeometry=true&maxAllowableOffset=&outSR=2264&outFields=label&f=pjson';              
                break;
            case 'ClosestHydrant':
                facEnv=makeFacilityEnvelope(jd,500);
                var urlStr = 'http://coa-gis-imagery/COA_Internal_ArcGIS/rest/services/Publish/test_route/MapServer/0/query?text=&geometry='+facEnv+
                             '&geometryType=esriGeometryEnvelope&inSR=2264&spatialRel=esriSpatialRelEnvelopeIntersects&relationParam=&objectIds=&where=&time='+
                             '&returnIdsOnly=false&returnGeometry=true&maxAllowableOffset=&outSR=2264&outFields=facilityid&f=pjson';              
                 break;
            default:  
                facEnv=makeFacilityEnvelope(jd,10000);
                var urlStr = 'http://coa-gis-imagery/COA_Internal_ArcGIS/rest/services/Publish/test_route/MapServer/1/query?text=&geometry='+facEnv+
                             '&geometryType=esriGeometryEnvelope&inSR=2264&spatialRel=esriSpatialRelEnvelopeIntersects&relationParam=&objectIds=&where=&time='+
                             '&returnIdsOnly=false&returnGeometry=true&maxAllowableOffset=&outSR=2264&outFields=label&f=pjson';              
                break;
            }//switch        
           

         $.ajax({
                   url: urlStr,
                   dataType: 'jsonp',
                   crossDomain: true,
                   jsonpCallback: 'MyJSONPCallback', // specify the callback name if you're hard-coding it
                   jsonp : "callback",
                   success:function(data){makeFacilityList(data,jd,closestType,distance);},
                   error:function(data){console.log('ajax failed1');$('#loading').css('visibility','hidden');}
        		   
               });        
        
        return urlStr;
    }//getFacilities
    
    function getClosest(jd,fac,closestType,distance){
         
       addressStr = $('#address').val();
       ZipStr = $('#zone').val();
	   xStr=jd.candidates[0].location.x;
	   yStr=jd.candidates[0].location.y;
	   
	   console.log(facEnv); 

	   
	   var urlStr = 'http://coa-gis-imagery/COA_Internal_ArcGIS/rest/services/Publish/test_route/NAServer/'+closestType+
	                '/solveClosestFacility?incidents='+xStr+'%2C'+yStr+'&facilities='+fac+'&barriers=&polylineBarriers='+
	                '&polygonBarriers=&travelDirection=esriNATravelDirectionToFacility&defaultCutoff=&defaultTargetFacilityCount=1'+
	                '&outSR=4326&accumulateAttributeNames=Distance&impedanceAttributeName=Distance&restrictionAttributeNames=Use+One+Way'+
	                '&attributeParameterValues=&restrictUTurns=esriNFSBAllowBacktrack&useHierarchy=true&returnDirections=true&'+
	                'returnCFRoutes=true&returnFacilities=false&returnIncidents=false&returnBarriers=false&returnPolylineBarriers=false'+
	                '&returnPolygonBarriers=false&directionsLanguage=en-US&directionsStyleName=NA+Desktop&outputLines=esriNAOutputLineTrueShape'+
	                '&outputGeometryPrecision=&outputGeometryPrecisionUnits=esriUnknownUnits&directionsTimeAttributeName=Drive+Time'+
	                '&directionsLengthUnits=esriNAUMiles&f=pjson';
       var pt = '';
       var retVal;
       
      
       $.ajax({
           url: urlStr,
           dataType: 'jsonp',
           crossDomain: true,
           jsonpCallback: 'MyJSONPCallback', // specify the callback name if you're hard-coding it
           jsonp : "callback",
           success:function(data){dispResults(data,distance);},
           error:function(data){console.log('ajax failed1');$('#loading').css('visibility','hidden');}
		   
       });
       
   }//getClosest
   
    
   
   var getResults = function(data,closestType,distance){
        console.log('ajax success');
        UpdateResults(data);
        getFacilities(data,closestType,distance)
        getLatLong(data);
        return data;
        
    }//getResults
       
    var makeFacilityList = function(data,jd,closestType,distance){
        console.log('ajax success');
        console.log(data);
        console.log(data.features.length);


            
        theFacs='{"features":[';
        

        for(var i=0;i< data.features.length;i++){
           switch(closestType)
                {
                case 'ClosestFireStation':
                    theFacs+='{"geometry":{"x":'+data.features[i].geometry.x+',"y":'+data.features[i].geometry.y+'},"attributes":{"Name":"'+data.features[i].attributes.label+'"}},';
                    break;
                case 'ClosestHydrant':
                    theFacs+='{"geometry":{"x":'+data.features[i].geometry.x+',"y":'+data.features[i].geometry.y+'},"attributes":{"Name":"'+data.features[i].attributes.facilityid+'"}},';
                    break;   
                default:  
                    theFacs+='{"geometry":{"x":'+data.features[i].geometry.x+',"y":'+data.features[i].geometry.y+'},"attributes":{"Name":"'+data.features[i].attributes.label+'"}},';
                    break;
                }//switch            
            
       }
        theFacs=theFacs.substring(0, theFacs.length-1); 
        theFacs=theFacs+']}';
        console.log(theFacs);
        getClosest(jd,theFacs,closestType,distance);
        
    }//makeFacilityList
    var dispResults = function(data,distance){
        console.log('ajax success');
        $('#loading').css('visibility','hidden');
         
        switch(distance)
            {
            case 'success':
             $('#results').append('test');
             $('#results').append('<p><b>' + data.routes.features[0].attributes.Total_Distance.toFixed(2) +'&nbsp' + 'miles to '+ data.routes.features[0].attributes.Name +'</p>');
              break;
            case 'feet':
              $('#results').append('<p><b>' + data.routes.features[0].attributes.Total_Distance.toFixed(3)*5280 +'&nbsp' + 'feet to '+ data.routes.features[0].attributes.Name +'</p>');
              break;   
            default:  
             $('#results').append('<p><b>' + data.routes.features[0].attributes.Total_Distance.toFixed(2) +'&nbsp' + 'miles to '+ data.routes.features[0].attributes.Name +'</p>');
            }//switch
            
            drawRoute(data)
    }   
	 
   </script>
  
  <style type="text/css">
    body,html,#main{margin:0;padding:0;height:100%;width:100%;}
    .panel {
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    -moz-box-shadow: 0px 6px 3px -3px #888;
    -webkit-box-shadow: 0px 6px 3px -3px #888;
    box-shadow: 0px 6px 3px -3px #888;
    border: 2px solid #86942A;
    margin: 5px 5px 5px 5px;
  }
  #map { height: 400px;
         width:  400px;
        }
  </style>
  

  
  </head>

  <body>

    

    <div class="container">

      

        <div class="span9">
          <div class="row-fluid">
            <div class="span9" >
              <h2>STEP 1</h2>
                       <p><b>Enter a street address.</b></p>
                        <div>
                            Address:&nbsp;<input type="text" class="span9" id="address" value="70 court pz" />
                        </div>
                        <div>
                            Zip:&nbsp;<input type="text" class="span2" id="zone" value="28801" />
                        </div>
            </div><!--/span-->
           </div>
        </div>
        
        <div class="span9">
          <div class="row-fluid">
            <div class="span9" >
              <p>&nbsp;</p>
            </div><!--/span-->
           </div>
        </div>

        <div class="span9">
          <div class="row-fluid">
            <div class="span9" >
               <h2>STEP 2</h2>
               <p><b>Click to find the closest.</b></p>
              <button type="submit" class="btn" id="Button1"  onclick="getAddress('ClosestFireStation','miles')" >Fire Station</button>
			  <button type="submit" class="btn" id="Button2"  onclick="getAddress('ClosestHydrant','feet')" >Fire Hydrant</button>
            </div><!--/span-->
           </div>
        </div>
        
        <div class="span9">
          <div class="row-fluid">
            <div class="span9" >
              <p>&nbsp;</p>
            </div><!--/span-->
           </div>
        </div>
  
        <div class="span9">
          <div class="row-fluid">
            <div class="span9" >
              <h2>STEP 3</h2>
              <p><b>Get Results.</b></p>
              <div id="results" ></div><div id = "loading" style="visibility:hidden"><img src="img/loading.gif" width="105" height="105"/> Seaching...</div>
            </div><!--/span-->
           </div>
        </div>
                 
        <div class="span9">
          <div class="row-fluid">
            <div class="span9" >
              <p>&nbsp;</p>
            </div><!--/span-->
           </div>
        </div>
  
        <div class="span9">
          <div class="row-fluid">
            <div class="span9" >
              <h2>STEP 4</h2>
              <p><b>View the map.</b></p>
              <div id="map" ></div>
            </div><!--/span-->
           </div>
        </div>
 
         <div class="span9">
          <div class="row-fluid">
            <div class="span9" >
              <p>&nbsp;</p>
            </div><!--/span-->
           </div>
        </div>

    </div> 


    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript">
  		//OSM_URL = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
		//OSM_ATTRIB = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors';

        //var map = L.map('map').setView([35.593,-82.5488], 13);
        //L.tileLayer(OSM_URL, {attribution: OSM_ATTRIB, styleId: 997}).addTo(map);
        var map = L.map('map').setView([35.593,-82.5488], 13);

		L.tileLayer('http://{s}.tile.cloudmade.com/{key}/22677/256/{z}/{x}/{y}.png', {
			attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2012 CloudMade',
			key: 'BC9A493B41014CAABB98F0471D759707'
		}).addTo(map);
    </script>
    <script type="text/javascript" src="js/bootstrap-transition.js"></script>
    <script type="text/javascript" src="js/bootstrap-alert.js"></script>
    <script type="text/javascript" src="js/bootstrap-modal.js"></script>
    <script type="text/javascript" src="js/bootstrap-dropdown.js"></script>
    <script type="text/javascript" src="js/bootstrap-scrollspy.js"></script>
    <script type="text/javascript" src="js/bootstrap-tab.js"></script>
    <script type="text/javascript" src="js/bootstrap-tooltip.js"></script>
    <script type="text/javascript" src="js/bootstrap-popover.js"></script>
    <script type="text/javascript" src="js/bootstrap-button.js"></script>
    <script type="text/javascript" src="js/bootstrap-collapse.js"></script>
    <script type="text/javascript" src="js/bootstrap-carousel.js"></script>
    <script type="text/javascript" src="js/bootstrap-typeahead.js"></script>
 
  </body>
</html>