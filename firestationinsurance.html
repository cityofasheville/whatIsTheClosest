<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Fire Station Insurance COA</title>
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 5px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>

    <script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
    <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
    <![endif]-->    <!-- <style type="text/javascript">#map { height: 180px; }</style> -->

    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" language="javascript">

      //setup 
      //This is for netorking
      var agsServerNetwork='coa-gis-imagery'; //ArcGIS  server name for networking
      var agsServerInstanceNameNetwork='COA_Internal_ArcGIS'; //ArcGIS  server instance for networking

      //hyrdrants
      var HydrantLayerIDX='0'; //layer index  for hydrants
      var HydrantNameField='facilityid'; //Field for name in hydrant layer
      var HydrantDistance=500; //Distance  to get hydrants around address this helps with performance

      //Fire stations
      var FireStationIDX='1'; //layer index  for fire stations
      var FireStationNameField='label'; //Field for name in fire station layer
      var FireStationDistance=15000; //Distance  to get fire stations around address  this helps with performance
      var RoutingServiceName='test_route'; //name of the map service containing  network and the closest facility problem
       

      //This is for geocoding
      var agsServerGeocode='gis.ashevillenc.gov'; //ArcGIS  server name for geocoding
      var agsServerInstanceNameGeocode='COA_ArcGIS_Server'; //ArcGIS  server instance for geocoding
      var geocdingLayerName='Buncombe_Streets_With_Zip'; //geocoding service to use.

      var mySRID=2264 //your projection id

    function UpdateResults(someData,idStr){
      $('#results').append('<span  class="text-success" ><strong>' + someData.candidates[0].address + '</strong></span>');
    }

    function getLatLong(someData){
      xStr=someData.candidates[0].location.x;
      yStr=someData.candidates[0].location.y;
      var urlStr = 'http://'+agsServerNetwork+'/'+agsServerInstanceNameNetwork+'/rest/services/Geometry/GeometryServer/project';
      var aPt='{"x":'+xStr+',"y":'+yStr+'}';

      var data={f:"json",inSR:mySRID,outSR:4326,geometries:aPt};

       $.ajax({
           url: urlStr,
           dataType: 'jsonp',
           data:data,
           crossDomain: true,
           success:function(data){zoomMap(data);},
           error:function(x,t,m){updateResultsFail(t,'Error with transforming to WGS84!');}
       });
     }

     var zoomMap = function(data){
      xStr=data.geometries[0].x;
      yStr=data.geometries[0].y;
      map.setView(new L.LatLng(yStr, xStr), 15);
      return '';
    }

    function getAddress(closestType,distance){
       clearMap();
       $('#results').html('');
       $('#loading').css('visibility','visible')
       addressStr = $('#address').val();
       ZipStr = $('#zone').val();
       var urlStr = 'http://'+agsServerGeocode+'/'+agsServerInstanceNameGeocode+'/rest/services/'+geocdingLayerName+'/GeocodeServer/findAddressCandidates';
       var data={f:"json",Street:addressStr,Zone:ZipStr};

       $.ajax({
           url: urlStr,
           dataType: 'jsonp',
           data:data,
           crossDomain: true,
           success:function(data){getResults(data,closestType,distance);},
           error:function(x,t,m){updateResultsFail(t,'Failed to get address!');}//console.log('ajax failed');}
       });
     }

     function drawRoute(data){
       var geojsonGroup = new L.LayerGroup();
       
       var path=data.routes.features[0].geometry.paths[0]
       var myLines = '[{"type": "LineString","coordinates":['
       for(var i=0;i< data.routes.features[0].geometry.paths.length;i++)
       {
            for(var j=0;j< data.routes.features[0].geometry.paths[i].length;j++){
                myLines += '['+data.routes.features[0].geometry.paths[i][j]+'],'
            }
       }
       
       myLines=myLines.substring(0, myLines.length-1)
       myLines += ']}]'
       myJsonObject=JSON.parse(myLines);
       
       var startPt = '[{"type": "Point","coordinates":['+data.routes.features[0].geometry.paths[0][0]+']}]';
       var endPt = '[{"type": "Point","coordinates":['+data.routes.features[0].geometry.paths[0][(data.routes.features[0].geometry.paths[0].length-1)]+']}]'

       var myStyle = {
           "color": "#C09853",
           "weight": 10,
           "opacity": 0.65
       };

       geoJSONLayer = L.geoJson(myJsonObject, {
           style: myStyle
       });
       
       var bounds = geoJSONLayer.getBounds();
       geoJSONLayer.addTo(map);
       drawPoints(startPt,'start');
       drawPoints(endPt,'end');
       map.fitBounds(bounds,100);
       map.zoomOut(1);    
    }
    
    function getColor(type){
        switch (type) {
            case 'start':
                return "#468847";
            case 'end':
                return "#B94A48";
            default:  
                return "#ff7800";
                break;
        }   
    }
    
    
    function drawPoints(GJfeat,type){
        GJfeatObject=JSON.parse(GJfeat);
        var geojsonMarkerOptions = {
            radius: 8,
            fillColor: getColor(type),
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
            
        };
        
        var gjPT = L.geoJson(GJfeatObject, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, geojsonMarkerOptions);
            }
        });

       gjPT.addTo(map);
           
    }
    
    function clearMap() {
        for(i in map._layers) {
            if(map._layers[i]._path != undefined) {
                try {
                    map.removeLayer(map._layers[i]);
                }
                catch(e) {
                    //do nothing....
                }
            }
        }
    }
        
    function makeFacilityEnvelope(someData,distance){

	   xStr=someData.candidates[0].location.x;
	   yStr=someData.candidates[0].location.y;
	   
	   maxX=parseFloat(parseFloat(xStr)+parseFloat(distance));
	   maxY=parseFloat(parseFloat(yStr)+parseFloat(distance));

	   minX=parseFloat(parseFloat(xStr)-parseFloat(distance));
	   minY=parseFloat(parseFloat(yStr)-parseFloat(distance));
	   
	   retVal='{"xmin":'+minX+',"ymin":'+minY+',"xmax":'+maxX+',"ymax":'+maxY+',"spatialReference":{"wkid":'+mySRID+'}}';
     
	   return retVal;
    }//makeFacilityEnvelope
    
    function getFacilities(someData,closestType,distance){
      var mainURL = 'http://'+agsServerNetwork+'/'+agsServerInstanceNameNetwork+'/rest/services/Publish/'+RoutingServiceName+'/MapServer/';

      switch(closestType){
        case 'ClosestFireStation':
          facEnv=makeFacilityEnvelope(someData,FireStationDistance);
          var urlStr = mainURL+FireStationIDX+'/query';
          var jobj = {f:"json",outSR:mySRID,inSR:mySRID,geometry:facEnv,geometryType:"esriGeometryEnvelope",spatialRel:"esriSpatialRelEnvelopeIntersects",outFields:"replacenamefield"};
          var jsonstr = JSON.stringify(jobj);
          jsonstr = jsonstr.replace("replacenamefield",FireStationNameField);
          jobj = $.parseJSON(jsonstr, true);          
          var data = jobj;
          break;
        case 'ClosestHydrant':
          facEnv=makeFacilityEnvelope(someData,HydrantDistance);
          var urlStr = mainURL+HydrantLayerIDX+'/query';          
          var jobj = {f:"json",outSR:mySRID,inSR:mySRID,geometry:facEnv,geometryType:"esriGeometryEnvelope",spatialRel:"esriSpatialRelEnvelopeIntersects",outFields:"replacenamefield"};
          var jsonstr = JSON.stringify(jobj);
          jsonstr = jsonstr.replace("replacenamefield",HydrantNameField);
          jobj = $.parseJSON(jsonstr, true);          
          var data = jobj;
          break;
        default:  
          facEnv=makeFacilityEnvelope(someData,FireStationDistance);
          var urlStr = mainURL+FireStationIDX+'/query';
          var jobj = {f:"json",outSR:mySRID,inSR:mySRID,geometry:facEnv,geometryType:"esriGeometryEnvelope",spatialRel:"esriSpatialRelEnvelopeIntersects",outFields:"replacenamefield"};
          var jsonstr = JSON.stringify(jobj);
          jsonstr = jsonstr.replace("replacenamefield",FireStationNameField);
          jobj = $.parseJSON(jsonstr, true);          
          var data = jobj;
          break;
        }//switch        
        
        $.ajax({
          url: urlStr,
          dataType: 'jsonp',
          data:data,
          crossDomain: true,
          success:function(data){makeFacilityList(data,someData,closestType,distance);},
          error:function(x,t,m){updateResultsFail(t,'Failed to find facilities for '+closestType+'!');},
          timeout:5000
        });        
        
        return urlStr;
    }//getFacilities
    
    function getClosest(someData,fac,closestType,distance){
         
       addressStr = $('#address').val();
       ZipStr = $('#zone').val();
       xStr=someData.candidates[0].location.x;
       yStr=someData.candidates[0].location.y;
	   
	     var urlStr = 'http://'+agsServerNetwork+'/'+agsServerInstanceNameNetwork+'/rest/services/Publish/'+RoutingServiceName+'/NAServer/'+closestType+'/solveClosestFacility';
       var data = {f:"json",outSR:4326,returnFacilities:false,returnIncidents:false,incidents:xStr+','+yStr,facilities:fac};      
      
       $.ajax({
           url: urlStr,
           dataType: 'jsonp',
           data:data,
           crossDomain: true,
           success:function(data){dispResults(data,distance,closestType);},
           error:function(x,tm){updateResultsFail(t,'Failed to get closeset facility!');}
       });
       
   }//getClosest
   
    
    var updateResultsFail = function(t,amsg){
      if(t==="timeout") {
        $('#loading').css('visibility','hidden');
        $('#results').append('<span  class="text-danger" ><strong>Unable to complete! Maybe you cannot access the data feeds?</strong></span>');        
      }else{
        $('#loading').css('visibility','hidden');
        $('#results').append('<span  class="text-danger" ><strong>' + amsg + '</strong></span>');
      }
    }//updateResultsFail

   var getResults = function(data,closestType,distance){
        
        if(data.candidates.length==0){
          updateResultsFail('','No matching addresses!');
        }else{
          UpdateResults(data);
          getFacilities(data,closestType,distance)
        }
        
        return data;
        
    }//getResults
       
    var makeFacilityList = function(data,someData,closestType,distance){

        theFacs='{"features":[';
        if (data.features.length == 0){
          $('#loading').css('visibility','hidden');
          $('#results').append('<span  class="text-danger" ><strong>Unable to find any Closest Locations!  <br/>'+
                                'You may not have access to the locations data or there are none.</strong></span>');
        }else{
          for(var i=0;i< data.features.length;i++){
             switch(closestType)
                  {
                  case 'ClosestFireStation':
                      theFacs+='{"geometry":{"x":'+data.features[i].geometry.x+',"y":'+data.features[i].geometry.y+'},"attributes":{"Name":"'+data.features[i].attributes.label+'"}},';
                      break;
                  case 'ClosestHydrant':
                      theFacs+='{"geometry":{"x":'+data.features[i].geometry.x+',"y":'+data.features[i].geometry.y+'},"attributes":{"Name":"'+data.features[i].attributes.facilityid+'"}},';
                      break;   
                  default:  
                      theFacs+='{"geometry":{"x":'+data.features[i].geometry.x+',"y":'+data.features[i].geometry.y+'},"attributes":{"Name":"'+data.features[i].attributes.label+'"}},';
                      break;
                  }//switch
          }
          theFacs=theFacs.substring(0, theFacs.length-1); 
          theFacs=theFacs+']}';
          getClosest(someData,theFacs,closestType,distance);
      }
    }//makeFacilityList

    var dispResults = function(data,distance,closestType){
        $('#loading').css('visibility','hidden');
        switch(distance){
            case 'feet':
                distTemp = parseFloat( data.routes.features[0].attributes.Total_Distance.toFixed(2) ).toFixed(2);
                dist = parseFloat(distTemp*5280).toFixed(2)
                distMsg = 'Feet';
                break;
            case 'miles':
                dist = parseFloat( data.routes.features[0].attributes.Total_Distance.toFixed(2) ).toFixed(2);
                distMsg = 'Miles';
                break;
            default:
                dist = parseFloat( data.routes.features[0].attributes.Total_Distance.toFixed(2) ).toFixed(2);
                distMsg = 'Miles';
                break;
        }
        switch(closestType){
            case 'ClosestFireStation':
                typeMsg = 'Fire Station';
                break;
            case 'ClosestHydrant':
                typeMsg = 'Fire Hydrant';
                break;
            default:
                typeMsg = 'Fire Station';
                break;
        };
        
        clMsg='<strong>&nbsp;Is Closest to&nbsp;</strong>'
        destMsg = data.routes.features[0].attributes.Name.replace('Location 1 - ','');
        
        $('#results').append(clMsg);
        $('#results').append('<span class="text-danger"><strong>'+typeMsg+' '+destMsg+'&nbsp;</strong></span>'+
                             '<span class="text-warning"><strong>('+dist+'&nbsp;'+distMsg+')</strong></span>');
        
           
        drawRoute(data)
    }
    function onEachFeature() {
      var popupContent = "<p>test!</p>";
      layer.bindPopup(popupContent);
    }
	 

   </script>
  
  <style type="text/css">
    #map { height: 400px;
           width:  100%;
          }
  </style>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-43089083-1', 'cityofasheville.github.io');
    ga('send', 'pageview');

  </script>
  </head>


  <body data-twttr-rendered="true" background-color="#F0F0F0">
    <div class="container bs-docs-container">



      <div class="panel panel-primary">
        <!--<div class="panel-heading"><h2>What's The Closest?</h2></div>-->
        <legend class="text-info"><h2>What's The Closest?</h2></legend>
        <fieldset>          
          <label class="text-info" for="address">Enter the Address</label>
          <input type="text" class="form-control" id="address" placeholder="70 court pz"  value="70 court pz">
          <br />
          <label class="text-info" for="zone">Enter the Zip Code</label>
          <input type="text" class="form-control" id="zone" placeholder="28801"  value="28801">     
          <br />
          <label class="text-info" for="Button1">Click to find the closest </label>
           <br/>
          <button type="submit" class="btn btn-primary btn-sm"  id="Button1"  onclick="getAddress('ClosestFireStation','miles')">Fire Station</button>
          <label class="text-info" for="Button2"> or </label>
          <button type="submit" class="btn btn-primary btn-sm"  id="Button2"  onclick="getAddress('ClosestHydrant','feet')">Fire Hydrant</button>
          <br/>
          <br/>
          <strong><label class="text-info" for="resultsholder">Get the Closest!</label></strong>
          <div  class="panel text-info" id="resultsholder" >
            <span id="results"></span>
            <span id="loading" class="text-info" style="visibility:hidden">
              <img   src="img/loading.gif" />
            </span>
          </div>
          <div  class="panel" id="map" ></div>
        </fieldset>
      </div>



    </div> 


    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript">
        var map = L.map('map').setView([35.593,-82.5488], 13);

		L.tileLayer('http://{s}.tile.cloudmade.com/{key}/22677/256/{z}/{x}/{y}.png', {
			attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2012 CloudMade',
			key: 'BC9A493B41014CAABB98F0471D759707'
		}).addTo(map);

    </script>
 
  </body>
</html>